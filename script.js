// Vocabulary lists for each user
const vocabListKhanh = [
  {"word": "antiquity", "type": "n", "vietnamese": "thời cổ đại, thời xa xưa"},
  {"word": "deliberately", "type": "adv", "vietnamese": "một cách có chủ ý, cố tình"},
  {"word": "ritually", "type": "adv", "vietnamese": "một cách có tính nghi thức, theo nghi lễ"},
  {"word": "hindsight", "type": "n", "vietnamese": "sự nhận thức muộn màng, sự nhìn lại sự việc sau khi nó xảy ra"},
  {"word": "excavation", "type": "n", "vietnamese": "cuộc khai quật"},
  {"word": "insurmountable", "type": "adj", "vietnamese": "không thể vượt qua được, không thể giải quyết được"},
  {"word": "conceived", "type": "v", "vietnamese": "được hình thành, được thai nghén (về ý tưởng)"},
  {"word": "enthusiasm", "type": "n", "vietnamese": "sự nhiệt tình, sự hào hứng"},
  {"word": "centrepiece", "type": "n", "vietnamese": "trung tâm, điểm nhấn quan trọng nhất"},
  {"word": "maritime", "type": "adj", "vietnamese": "thuộc về hàng hải, biển cả"},
  {"word": "curiosity", "type": "n", "vietnamese": "sự tò mò, sự ham hiểu biết"},
  {"word": "immersed", "type": "adj", "vietnamese": "chìm đắm, đắm chìm (trong một hoạt động, công việc, môi trường)"},
  {"word": "perceived", "type": "v", "vietnamese": "được nhận thức, được hiểu là"},
  {"word": "eminent", "type": "adj", "vietnamese": "xuất chúng, kiệt xuất, lỗi lạc"},
  {"word": "surpassing", "type": "adj", "vietnamese": "vượt trội, xuất sắc hơn bình thường"},
  {"word": "byproduct", "type": "n", "vietnamese": "sản phẩm phụ, kết quả phụ"},
  {"word": "tuberculosis", "type": "n", "vietnamese": "bệnh lao"},
  {"word": "utilising", "type": "n", "vietnamese": "sử dụng, tận dụng"},
  {"word": "derived", "type": "v", "vietnamese": "bắt nguồn từ, có nguồn gốc từ"},
  {"word": "consulted", "type": "v", "vietnamese": "được tham khảo, được tư vấn"},
  {"word": "intricately", "type": "adv", "vietnamese": "một cách tinh xảo, tỉ mỉ"},
  {"word": "wedge", "type": "n", "vietnamese": "miếng nêm"},
  {"word": "timber", "type": "n", "vietnamese": "thanh gỗ"},
  {"word": "stitching", "type": "n", "vietnamese": "quá trình khâu nối, may kết hợp các bộ phận"},
  {"word": "heritage", "type": "n", "vietnamese": "di sản"},
  {"word": "cultural", "type": "adj", "vietnamese": "liên quan đến văn hóa, thuộc về văn hóa"},
  {"word": "dwell", "type": "v", "vietnamese": "ở lại, lưu lại"},
  {"word": "destination", "type": "n", "vietnamese": "điểm đến, đích đến"},
  {"word": "prospect", "type": "n", "vietnamese": "triển vọng, tiềm năng"},
  {"word": "commercial", "type": "adj", "vietnamese": "liên quan đến kinh doanh, thương mại"},
  {"word": "venture", "type": "n", "vietnamese": "dự án kinh doanh, hoạt động kinh doanh mạo hiểm"},
  {"word": "premises", "type": "n", "vietnamese": "cơ sở, tòa nhà, khuôn viên"},
  {"word": "crockery", "type": "n", "vietnamese": "đồ sứ, đồ gốm dùng trong sinh hoạt hằng ngày"},
  {"word": "commodity", "type": "n", "vietnamese": "hàng hóa, sản phẩm thương mại có giá trị cao"},
  {"word": "draughty", "type": "adj", "vietnamese": "có gió lùa, rò rỉ gió (không kín, gây ra cảm giác lạnh lẽo)"},
  {"word": "volcanic", "type": "adj", "vietnamese": "liên quan đến núi lửa, đặc trưng bởi hoạt động núi lửa"},
  {"word": "ash", "type": "n", "vietnamese": "tro, chất cặn bã sau phun trào núi lửa"},
  {"word": "alchemist", "type": "n", "vietnamese": "nhà giả kim, người nghiên cứu biến đổi các kim loại"},
  {"word": "figurines", "type": "n", "vietnamese": "tượng nhỏ, bức tượng mô tả hình dạng người, động vật hoặc thần linh"},
  {"word": "porous", "type": "adj", "vietnamese": "xốp, có nhiều lỗ nhỏ cho phép thấm nước, không kín hoàn toàn"},
  {"word": "senior", "type": "adj", "vietnamese": "cao cấp, thuộc tầng lớp lãnh đạo chủ chốt"},
  {"word": "management", "type": "n", "vietnamese": "quản lý, ban giám đốc"},
  {"word": "enrolment", "type": "n", "vietnamese": "quá trình đăng ký học, ghi danh"},
  {"word": "concerned", "type": "adj", "vietnamese": "có liên quan, liên quan đến"},
  {"word": "primate", "type": "n", "vietnamese": "loài linh trưởng"},
  {"word": "anthropology", "type": "n", "vietnamese": "nhân học"},
  {"word": "plummet", "type": "v", "vietnamese": "giảm mạnh, tụt dốc"},
  {"word": "repertoire", "type": "n", "vietnamese": "bộ sưu tập, kho tàng"},
  {"word": "kerb", "type": "n", "vietnamese": "lề đường"},
  {"word": "minor", "type": "adj", "vietnamese": "nhỏ, không đáng kể"},
  {"word": "mishap", "type": "n", "vietnamese": "sự cố, rủi ro nhỏ"},
  {"word": "gesticulate", "type": "v", "vietnamese": "khoa tay múa chân (để diễn đạt ý)"},
  {"word": "negotiate", "type": "v", "vietnamese": "vượt qua, đàm phán"},
  {"word": "manoeuvre", "type": "n", "vietnamese": "động tác, thao tác (khi lái xe hoặc điều khiển máy móc)"},
  {"word": "adept", "type": "adj", "vietnamese": "thành thạo, giỏi"},
  {"word": "collision", "type": "n", "vietnamese": "sự va chạm"},
  {"word": "seize up", "type": "v", "vietnamese": "bị kẹt, ngừng hoạt động"},
  {"word": "mimic", "type": "v", "vietnamese": "bắt chước"},
  {"word": "ubiquitous", "type": "adj", "vietnamese": "phổ biến, có mặt ở khắp nơi"},
  {"word": "verge", "type": "n", "vietnamese": "bờ vực, sắp sửa xảy ra"},
  {"word": "counterpart", "type": "n", "vietnamese": "đối tác, bản sao tương đương"},
  {"word": "stumbling", "type": "adj", "vietnamese": "vấp váp, gặp khó khăn"},
  {"word": "etiquette", "type": "n", "vietnamese": "phép tắc, quy tắc ứng xử"},
  {"word": "fairly", "type": "adv", "vietnamese": "khá, tương đối"},
  {"word": "static", "type": "adj", "vietnamese": "tĩnh, không thay đổi"},
  {"word": "cumbersome", "type": "adj", "vietnamese": "cồng kềnh, khó di chuyển"},
  {"word": "cortex", "type": "n", "vietnamese": "vỏ não"},
  {"word": "alternative", "type": "n", "vietnamese": "sự thay thế / thay thế"},
  {"word": "pragmatic", "type": "adj", "vietnamese": "thực tế, thực dụng"},
  {"word": "philosopher", "type": "n", "vietnamese": "nhà triết học"},
  {"word": "unveil", "type": "v", "vietnamese": "tiết lộ, công bố (một điều mới mẻ)"},
  {"word": "insufficiently", "type": "adv", "vietnamese": "không đủ"},
  {"word": "prominence", "type": "n", "vietnamese": "sự nổi bật"},
  {"word": "one-time", "type": "adj", "vietnamese": "từng (một lần)"},
  {"word": "panacea", "type": "n", "vietnamese": "giải pháp toàn diện"},
  {"word": "consensus", "type": "n", "vietnamese": "sự đồng thuận"},
  {"word": "phenomenon", "type": "n", "vietnamese": "hiện tượng"},
  {"word": "rhetorically", "type": "adv", "vietnamese": "mang tính tu từ"},
  {"word": "encoding", "type": "n", "vietnamese": "việc mã hóa"},
  {"word": "compelling", "type": "adj", "vietnamese": "hấp dẫn, thuyết phục"},
  {"word": "robust", "type": "adj", "vietnamese": "mạnh mẽ, chắc chắn"},
  {"word": "misperception", "type": "n", "vietnamese": "hiểu sai, nhận thức sai"},
  {"word": "strategic", "type": "adj", "vietnamese": "mang tính chiến lược"},
  {"word": "deceive", "type": "v", "vietnamese": "lừa dối"},
  {"word": "persistence", "type": "n", "vietnamese": "tính kiên trì"},
  {"word": "inevitable", "type": "adj", "vietnamese": "không thể tránh khỏi"},
  {"word": "flourish", "type": "v", "vietnamese": "phát triển mạnh"},
  {"word": "agency", "type": "n", "vietnamese": "cơ quan, tổ chức"},
  {"word": "skepticism", "type": "n", "vietnamese": "sự hoài nghi"},
  {"word": "cognitive", "type": "adj", "vietnamese": "liên quan đến nhận thức"},
  {"word": "curtail", "type": "v", "vietnamese": "cắt giảm, hạn chế"},
  {"word": "possess", "type": "v", "vietnamese": "sở hữu"},
  {"word": "rugged", "type": "adj", "vietnamese": "bền bỉ, chắc chắn"},
  {"word": "predominantly", "type": "adv", "vietnamese": "chủ yếu"},
  {"word": "prowl", "type": "v", "vietnamese": "đi rình mò"},
  {"word": "majority", "type": "n", "vietnamese": "phần lớn"}
];

const vocabListThanh = [
  {"word": "prodigious", "type": "adj", "vietnamese": "phi thường, xuất sắc"},
  {"word": "radioactivity", "type": "n", "vietnamese": "sự phóng xạ"},
  {"word": "phenomenon", "type": "n", "vietnamese": "hiện tượng"},
  {"word": "remarkable", "type": "adj", "vietnamese": "đáng chú ý, phi thường"},
  {"word": "investment", "type": "n", "vietnamese": "khoản đầu tư"},
  {"word": "finance", "type": "v", "vietnamese": "tài trợ, cung cấp kinh phí"},
  {"word": "secondary", "type": "adj", "vietnamese": "thuộc cấp trung học"},
  {"word": "fulfilled", "type": "v", "vietnamese": "hoàn thành, thực hiện"},
  {"word": "examination", "type": "n", "vietnamese": "kỳ thi, bài kiểm tra"},
  {"word": "partnership", "type": "n", "vietnamese": "sự hợp tác"},
  {"word": "significance", "type": "n", "vietnamese": "tầm quan trọng"},
  {"word": "substance", "type": "n", "vietnamese": "chất, vật chất"},
  {"word": "discovery", "type": "n", "vietnamese": "sự khám phá, phát hiện"},
  {"word": "shaft", "type": "n", "vietnamese": "hố sâu, trục đào"},
  {"word": "structure", "type": "n", "vietnamese": "cấu trúc, công trình"},
  {"word": "prehistoric", "type": "adj", "vietnamese": "thuộc thời tiền sử"},
  {"word": "sediment", "type": "n", "vietnamese": "trầm tích"},
  {"word": "excavation", "type": "n", "vietnamese": "cuộc khai quật"},
  {"word": "complicated", "type": "adj", "vietnamese": "phức tạp"},
  {"word": "wedge", "type": "n", "vietnamese": "nêm (một mảnh gỗ hoặc kim loại dùng để chêm, cố định)"},
  {"word": "timber", "type": "n", "vietnamese": "gỗ xây dựng, gỗ kiến trúc"},
  {"word": "antiquity", "type": "n", "vietnamese": "thời cổ đại"},
  {"word": "deliberately", "type": "adv", "vietnamese": "một cách có chủ ý, cố tình"},
  {"word": "narrower", "type": "adj", "vietnamese": "hẹp hơn"},
  {"word": "audience", "type": "n", "vietnamese": "khán giả, người xem, người tiếp nhận thông tin"},
  {"word": "conference", "type": "n", "vietnamese": "hội nghị"},
  {"word": "perception", "type": "n", "vietnamese": "nhận thức, quan niệm"},
  {"word": "society", "type": "n", "vietnamese": "xã hội, cộng đồng"},
  {"word": "apparent", "type": "adj", "vietnamese": "rõ ràng, dễ thấy"},
  {"word": "reconstruction", "type": "n", "vietnamese": "sự tái tạo, sự phục dựng"},
  {"word": "assessment", "type": "n", "vietnamese": "sự đánh giá"},
  {"word": "hypothesis", "type": "n", "vietnamese": "giả thuyết"},
  {"word": "institution", "type": "n", "vietnamese": "tổ chức, cơ quan"},
  {"word": "provide", "type": "v", "vietnamese": "cung cấp"},
  {"word": "generous", "type": "adj", "vietnamese": "hào phóng"},
  {"word": "government", "type": "n", "vietnamese": "chính phủ"},
  {"word": "surgery", "type": "n", "vietnamese": "phẫu thuật"},
  {"word": "contact", "type": "v", "vietnamese": "liên lạc"},
  {"word": "helmsman", "type": "n", "vietnamese": "người lái tàu"},
  {"word": "equipment", "type": "n", "vietnamese": "thiết bị"},
  {"word": "involve", "type": "v", "vietnamese": "liên quan đến"},
  {"word": "condition", "type": "n", "vietnamese": "điều kiện"},
  {"word": "competence", "type": "n", "vietnamese": "năng lực, khả năng"},
  {"word": "technique", "type": "n", "vietnamese": "kỹ thuật"},
  {"word": "situation", "type": "n", "vietnamese": "tình huống"},
  {"word": "essential", "type": "adj", "vietnamese": "cần thiết, quan trọng"},
  {"word": "experience", "type": "n", "vietnamese": "kinh nghiệm"},
  {"word": "emergency", "type": "n", "vietnamese": "tình huống khẩn cấp"},
  {"word": "motivating", "type": "adj", "vietnamese": "tạo động lực"},
  {"word": "stormy", "type": "adj", "vietnamese": "bão tố, đầy sóng gió"},
  {"word": "actually", "type": "adv", "vietnamese": "thực ra"},
  {"word": "rewarding", "type": "adj", "vietnamese": "đáng giá, bổ ích"},
  {"word": "recycling", "type": "n", "vietnamese": "tái chế"},
  {"word": "presentation", "type": "n", "vietnamese": "bài thuyết trình"},
  {"word": "perhaps", "type": "adv", "vietnamese": "có lẽ"},
  {"word": "ordinary", "type": "adj", "vietnamese": "bình thường"},
  {"word": "pupil", "type": "n", "vietnamese": "học sinh"},
  {"word": "compare", "type": "v", "vietnamese": "so sánh"},
  {"word": "footwear", "type": "n", "vietnamese": "giày dép"},
  {"word": "high-heeled", "type": "adj", "vietnamese": "có gót cao"},
  {"word": "expensive", "type": "adj", "vietnamese": "đắt tiền"},
  {"word": "worn", "type": "adj", "vietnamese": "mòn, sờn"},
  {"word": "beginner", "type": "n", "vietnamese": "người mới bắt đầu"}
];

// Hardcoded login credentials
const credentials = {
  khanh: "026895",
  thanh: "026318"
};

let currentVocabList = [];
let unseenWords = [];
let wrongStack = [];
let currentWord = null;
let lastWord = null;
let score = 0;
let hintIndex = 0;
let currentAttempt = 0;

// DOM Elements for login screen
const loginScreen = document.getElementById("login-screen");
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("login-btn");
const loginFeedback = document.getElementById("login-feedback");

// DOM Elements for quiz screen
const quizScreen = document.getElementById("quiz-screen");
const progressEl = document.getElementById("progress");
const vietnameseEl = document.getElementById("vietnamese");
const wordInput = document.getElementById("wordInput");
const typeInput = document.getElementById("typeInput");
const checkBtn = document.getElementById("check-btn");
const hintBtn = document.getElementById("hint-btn");
const hintEl = document.getElementById("hint");
const feedbackEl = document.getElementById("feedback");
const skipBtn = document.getElementById("skip-btn");

const correctSound = document.getElementById("correct-sound");
const wrongSound = document.getElementById("wrong-sound");

// Login function
function loginFunction() {
  const username = usernameInput.value.trim().toLowerCase();
  const password = passwordInput.value.trim();

  if (!(username in credentials)) {
    loginFeedback.textContent = "Wrong username.";
    loginFeedback.style.color = "red";
    return;
  }
  if (credentials[username] !== password) {
    loginFeedback.textContent = "Wrong password.";
    loginFeedback.style.color = "red";
    return;
  }
  
  loginFeedback.textContent = "Đăng nhập thành công!";
  loginFeedback.style.color = "green";
  // Set the vocabulary list based on the username
  currentVocabList = (username === "khanh") ? vocabListKhanh :
                     (username === "thanh") ? vocabListThanh : [];
  startExam();
}

// Bind Enter key for login
usernameInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    loginFunction();
  }
});
passwordInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    loginFunction();
  }
});
loginBtn.addEventListener("click", loginFunction);

// Quiz event listeners
checkBtn.addEventListener("click", checkAnswer);
hintBtn.addEventListener("click", showHint);
skipBtn.addEventListener("click", skipQuestion);

// Bind Enter key for submitting the answer
wordInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    checkAnswer();
  }
});
typeInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    checkAnswer();
  }
});

// Start the quiz after successful login
function startExam() {
  // Hide login screen and show quiz screen
  loginScreen.style.display = "none";
  quizScreen.style.display = "block";
  score = 0;
  unseenWords = [...currentVocabList];
  wrongStack = [];
  progressEl.textContent = `Đã đúng: ${score}/${currentVocabList.length}`;
  nextQuestion();
}

function nextQuestion() {
  if (unseenWords.length === 0 && wrongStack.length === 0) {
    endQuiz();
    return;
  }
  
  // Choose next word (avoid repeating the last one if possible)
  let candidates = unseenWords.length > 0 ? unseenWords : wrongStack;
  if (candidates.length > 1 && lastWord) {
    candidates = candidates.filter(w => w !== lastWord);
  }
  
  currentWord = candidates[Math.floor(Math.random() * candidates.length)];
  
  // Remove from unseenWords if present
  const index = unseenWords.indexOf(currentWord);
  if (index !== -1) {
    unseenWords.splice(index, 1);
  }
  
  currentAttempt = 0;
  hintIndex = 0;
  vietnameseEl.textContent = `Nghĩa: ${currentWord.vietnamese}`;
  wordInput.value = "";
  typeInput.value = "";
  feedbackEl.textContent = "";
  hintEl.textContent = "Gợi ý: ";
  wordInput.focus();
}

function showHint() {
  const correctWord = currentWord.word;
  if (hintIndex < correctWord.length) {
    hintIndex++;
  }
  hintEl.textContent = `Gợi ý: ${correctWord.substring(0, hintIndex)} (${currentWord.type})`;
}

function skipQuestion() {
  if (!wrongStack.includes(currentWord)) {
    wrongStack.push(currentWord);
  }
  lastWord = currentWord;
  nextQuestion();
}

function checkAnswer() {
  const userWord = wordInput.value.trim().toLowerCase();
  const userType = typeInput.value.trim().toLowerCase();
  const correctWord = currentWord.word.trim().toLowerCase();
  const correctType = currentWord.type.trim().toLowerCase();
  
  if (userWord === correctWord && userType === correctType) {
    if (currentAttempt > 0 || hintIndex > 0) {
      feedbackEl.textContent = "Đúng nhưng không tính điểm vì đã sai/gợi ý. Từ này sẽ xuất hiện lại.";
      feedbackEl.style.color = "orange";
      if (!wrongStack.includes(currentWord)) {
        wrongStack.push(currentWord);
      }
      correctSound.play();
    } else {
      feedbackEl.textContent = "Đúng!";
      feedbackEl.style.color = "green";
      score++;
      progressEl.textContent = `Đã đúng: ${score}/${currentVocabList.length}`;
      correctSound.play();
      // Remove from wrongStack if present
      const idx = wrongStack.indexOf(currentWord);
      if (idx !== -1) {
        wrongStack.splice(idx, 1);
      }
    }
    lastWord = currentWord;
    nextQuestion();
  } else {
    currentAttempt++;
    feedbackEl.textContent = "Sai! Mời thử lại.";
    feedbackEl.style.color = "red";
    wrongSound.play();
  }
}

function endQuiz() {
  vietnameseEl.textContent = "Kết thúc kiểm tra!";
  feedbackEl.textContent = `Điểm của bạn: ${score}`;
  wordInput.disabled = true;
  typeInput.disabled = true;
}
